"use client";

import { useState, useCallback, useEffect, useRef } from "react";
import { apiUrl } from "../lib/api";
import { SEVERITY_LEVELS } from "../lib/severity";
import { HostMultiSelect } from "./host-multi-select";
import { VulnAttachmentsSection } from "./vuln-attachments-section";
import { PendingAttachmentsSection, type PendingAttachmentsHandle } from "./pending-attachments-section";

type Subnet = { id: string; cidr: string; name: string | null };

type Props = {
  missionId: string;
  hostId: string | null;
  hostIp: string | null;
  hosts: { id: string; ip: string; dns_name: string | null; subnet_id?: string | null }[];
  subnets?: Subnet[];
  portsByHost: Record<string, { id: string; number: number; protocol: string }[]>;
  mode: "add" | "edit";
  vuln?: {
    definition_id: string;
    title: string;
    severity: string | null;
    cvss_score: number | null;
    cve_ids: string[];
    description_md: string | null;
    evidence_md: string | null;
    discovered_by: string | null;
    port_id: string | null;
    affected_subnet_ids?: string[];
    affected_host_ids?: string[];
  };
  onClose: () => void;
  onSubmit: (data: {
    hostIds: string[];
    title: string;
    severity: string;
    cvss_score: number | null;
    cve_ids: string[];
    description_md: string | null;
    evidence_md: string | null;
    subnet_ids: string[];
  }) => Promise<{ id: string } | void>;
  canEdit?: boolean;
  onRefresh?: () => void;
};

function parseCveInput(raw: string): string[] {
  return raw
    .split(/[\s,]+/)
    .map((s) => s.trim().toUpperCase())
    .filter((s) => s.length > 0 && /^CVE-\d{4}-\d+$/i.test(s));
}

export function VulnerabilityModal({
  missionId,
  hostId: initialHostId,
  hostIp,
  hosts,
  subnets = [],
  portsByHost,
  mode,
  vuln,
  onClose,
  onSubmit,
  canEdit = true,
  onRefresh,
}: Props) {
  const [validationError, setValidationError] = useState<string | null>(null);
  const [modalRef, setModalRef] = useState<HTMLDivElement | null>(null);
  const [pendingAttachments, setPendingAttachments] = useState<File[]>([]);
  const pendingAttachmentsRef = useRef<PendingAttachmentsHandle>(null);
  const [selectedHostIds, setSelectedHostIds] = useState<Set<string>>(
    () => {
      if (vuln?.affected_host_ids?.length) return new Set(vuln.affected_host_ids);
      if (initialHostId) return new Set([initialHostId]);
      return new Set(hosts[0] ? [hosts[0].id] : []);
    }
  );
  const [selectedSubnetIds, setSelectedSubnetIds] = useState<Set<string>>(
    new Set(vuln?.affected_subnet_ids ?? [])
  );

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setValidationError(null);
    const form = e.currentTarget;
    const title = (form.elements.namedItem("title") as HTMLInputElement).value.trim();
    const severity = (form.elements.namedItem("severity") as HTMLSelectElement).value;
    const cvssRaw = (form.elements.namedItem("cvss_score") as HTMLInputElement).value.trim();
    const cvss_score = cvssRaw ? Math.min(10, Math.max(0, parseFloat(cvssRaw))) : null;
    const cveRaw = (form.elements.namedItem("cve_ids") as HTMLInputElement).value.trim();
    const cve_ids = parseCveInput(cveRaw);
    const descriptionMd = (form.elements.namedItem("description_md") as HTMLTextAreaElement).value.trim() || null;
    const evidenceMd = (form.elements.namedItem("evidence_md") as HTMLTextAreaElement).value.trim() || null;

    const hostIds = Array.from(selectedHostIds);
    if (hostIds.length === 0) {
      setValidationError("Select at least one affected host.");
      return;
    }
    if (!title) {
      setValidationError("Title is required.");
      return;
    }

    const result = await onSubmit({
      hostIds,
      title,
      severity: severity || "Medium",
      cvss_score: cvss_score ?? null,
      cve_ids,
      description_md: descriptionMd,
      evidence_md: evidenceMd,
      subnet_ids: Array.from(selectedSubnetIds),
    });
    if (mode === "add" && result && "id" in result && pendingAttachments.length > 0) {
      for (const file of pendingAttachments) {
        const fd = new FormData();
        fd.append("file", file);
        await fetch(apiUrl(`/api/vulnerability-definitions/${result.id}/attachments`), {
          method: "POST",
          credentials: "include",
          body: fd,
        });
      }
    }
    onClose();
  };

  const handlePaste = useCallback(
    (e: ClipboardEvent) => {
      const items = e.clipboardData?.items;
      if (!items) return;
      for (const item of items) {
        if (item.type.startsWith("image/")) {
          e.preventDefault();
          const file = item.getAsFile();
          if (!file) return;
          if (mode === "edit" && vuln?.definition_id && canEdit) {
            const fd = new FormData();
            fd.append("file", file);
            fetch(apiUrl(`/api/vulnerability-definitions/${vuln.definition_id}/attachments/paste`), {
              method: "POST",
              credentials: "include",
              body: fd,
            }).then(() => onRefresh?.());
          } else if (mode === "add") {
            pendingAttachmentsRef.current?.addFile(file, true);
          }
          return;
        }
      }
    },
    [mode, vuln?.definition_id, canEdit, onRefresh]
  );

  useEffect(() => {
    const el = modalRef;
    if (!el) return;
    el.addEventListener("paste", handlePaste);
    return () => el.removeEventListener("paste", handlePaste);
  }, [modalRef, handlePaste]);

  const displayHosts = hosts;

  return (
    <div
      style={{
        position: "fixed",
        inset: 0,
        backgroundColor: "rgba(0,0,0,0.6)",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: 1000,
      }}
      onClick={onClose}
    >
      <div
        ref={setModalRef}
        tabIndex={-1}
        style={{
          backgroundColor: "var(--bg-panel)",
          borderRadius: 8,
          border: "1px solid var(--border)",
          padding: 24,
          maxWidth: 560,
          width: "90%",
          maxHeight: "90vh",
          overflowY: "auto",
        }}
        onClick={(e) => e.stopPropagation()}
      >
        <h2 style={{ margin: "0 0 16px", fontSize: "1.25rem" }}>
          {mode === "add" ? "Add Vulnerability" : "Edit Vulnerability"}
        </h2>
        {initialHostId && hostIp && (
          <p style={{ margin: "0 0 16px", fontSize: 14, color: "var(--text-muted)" }}>
            Host: {hostIp}
          </p>
        )}
        <form onSubmit={handleSubmit}>
          {validationError && (
            <div style={{ padding: 12, backgroundColor: "var(--error-bg)", color: "var(--error)", borderRadius: 8, marginBottom: 16, fontSize: 14 }}>
              {validationError}
            </div>
          )}
          {(mode === "add" || mode === "edit") && subnets.length > 0 && (
            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", marginBottom: 4 }}>☑ Apply to all hosts in selected subnet(s)</label>
              <p style={{ fontSize: 12, color: "var(--text-muted)", marginBottom: 8 }}>
                Hosts in selected subnets inherit this vulnerability. New hosts added to the subnet will also be affected.
              </p>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                {subnets.map((s) => (
                  <label key={s.id} style={{ display: "flex", alignItems: "center", gap: 6, cursor: "pointer" }}>
                    <input
                      type="checkbox"
                      checked={selectedSubnetIds.has(s.id)}
                      onChange={(e) => {
                        setSelectedSubnetIds((prev) => {
                          const next = new Set(prev);
                          if (e.target.checked) next.add(s.id);
                          else next.delete(s.id);
                          return next;
                        });
                      }}
                    />
                    <span style={{ fontSize: 13 }}>{s.cidr}{s.name ? ` (${s.name})` : ""}</span>
                  </label>
                ))}
              </div>
            </div>
          )}
          <div style={{ marginBottom: 12 }}>
            <label style={{ display: "block", marginBottom: 4 }}>Affected hosts</label>
            <HostMultiSelect
              hosts={displayHosts}
              selectedIds={selectedHostIds}
              onChange={setSelectedHostIds}
              placeholder="Search by IP or hostname…"
            />
          </div>
          <div style={{ marginBottom: 12 }}>
            <label style={{ display: "block", marginBottom: 4 }}>Title (required)</label>
            <input
              name="title"
              type="text"
              required
              placeholder="e.g. OpenSSH weak key exchange"
              defaultValue={vuln?.title ?? ""}
              className="theme-input"
            />
          </div>
          <div style={{ display: "flex", gap: 12, marginBottom: 12 }}>
            <div style={{ flex: 1 }}>
              <label style={{ display: "block", marginBottom: 4 }}>Severity</label>
              <select
                name="severity"
                defaultValue={vuln?.severity ?? "Medium"}
                className="theme-input"
              >
                {SEVERITY_LEVELS.map((s) => (
                  <option key={s} value={s}>{s}</option>
                ))}
              </select>
            </div>
            <div style={{ flex: 1 }}>
              <label style={{ display: "block", marginBottom: 4 }}>CVSS score (0–10)</label>
              <input
                name="cvss_score"
                type="number"
                min={0}
                max={10}
                step={0.1}
                placeholder="—"
                defaultValue={vuln?.cvss_score ?? ""}
                className="theme-input"
              />
            </div>
          </div>
          <div style={{ marginBottom: 12 }}>
            <label style={{ display: "block", marginBottom: 4 }}>CVE(s) (comma or space separated)</label>
            <input
              name="cve_ids"
              type="text"
              placeholder="CVE-2024-1234, CVE-2024-5678"
              defaultValue={vuln?.cve_ids?.join(", ") ?? ""}
              className="theme-input"
            />
          </div>
          <div style={{ marginBottom: 12 }}>
            <label style={{ display: "block", marginBottom: 4 }}>Description (markdown)</label>
            <textarea
              name="description_md"
              rows={4}
              placeholder="Vulnerability description..."
              defaultValue={vuln?.description_md ?? ""}
              className="theme-input"
              style={{ width: "100%", resize: "vertical" }}
            />
          </div>
          <div style={{ marginBottom: 12 }}>
            <label style={{ display: "block", marginBottom: 4 }}>Evidence / notes (markdown)</label>
            <textarea
              name="evidence_md"
              rows={4}
              placeholder="Evidence and notes..."
              defaultValue={vuln?.evidence_md ?? ""}
              className="theme-input"
              style={{ width: "100%", resize: "vertical" }}
            />
          </div>
          {mode === "add" && (
            <div style={{ marginBottom: 16 }}>
              <PendingAttachmentsSection ref={pendingAttachmentsRef} onChange={setPendingAttachments} />
            </div>
          )}
          {mode === "edit" && vuln?.definition_id && (
            <div style={{ marginBottom: 16 }}>
              <VulnAttachmentsSection vulnDefId={vuln.definition_id} canEdit={canEdit} onRefresh={onRefresh} />
            </div>
          )}
          <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
            <button type="button" className="theme-btn theme-btn-ghost" onClick={onClose}>
              Cancel
            </button>
            <button type="submit" className="theme-btn theme-btn-primary">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
