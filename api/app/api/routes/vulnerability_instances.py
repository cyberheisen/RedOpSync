from uuid import UUID
import hashlib

from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session, joinedload

from app.core.deps import get_current_user
from app.db.session import get_db
from app.models.models import VulnerabilityDefinition, VulnerabilityInstance, User
from app.schemas.vulnerability_instance import VulnerabilityInstanceRead
from app.services.vuln_affected import get_affected_host_ids

router = APIRouter()


def _instance_to_read(r: VulnerabilityInstance) -> VulnerabilityInstanceRead:
    d = r.definition
    return VulnerabilityInstanceRead(
        id=r.id,
        project_id=r.project_id,
        vulnerability_definition_id=r.vulnerability_definition_id,
        definition_title=d.title if d else None,
        definition_severity=d.severity if d else None,
        definition_cvss_score=d.cvss_score if d else None,
        definition_description_md=d.description_md if d else None,
        definition_evidence_md=d.evidence_md if d else None,
        definition_cve_ids=d.cve_ids if d else None,
        definition_discovered_by=d.discovered_by if d else None,
        definition_created_at=d.created_at if d else None,
        definition_updated_at=d.updated_at if d else None,
        host_id=r.host_id,
        port_id=r.port_id,
        status=r.status,
        notes_md=r.notes_md,
        created_at=r.created_at,
        updated_at=r.updated_at,
    )


@router.get("", response_model=list[VulnerabilityInstanceRead])
def list_vulnerability_instances(
    project_id: UUID | None = Query(None),
    host_id: UUID | None = Query(None),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    q = db.query(VulnerabilityInstance).options(
        joinedload(VulnerabilityInstance.definition)
    )
    if project_id is not None:
        q = q.filter(VulnerabilityInstance.project_id == project_id)
    if host_id is not None:
        q = q.filter(VulnerabilityInstance.host_id == host_id)
    rows = q.order_by(VulnerabilityInstance.created_at.desc()).all()
    result = [_instance_to_read(r) for r in rows]

    if host_id and project_id:
        direct_def_ids = {r.vulnerability_definition_id for r in rows}
        defs = db.query(VulnerabilityDefinition).filter(
            VulnerabilityDefinition.project_id == project_id
        ).all()
        for d in defs:
            if d.id in direct_def_ids:
                continue
            affected = get_affected_host_ids(db, d)
            if host_id in affected:
                synthetic_id = UUID(hex=hashlib.md5(f"subnet:{d.id}:{host_id}".encode()).hexdigest())
                result.append(
                    VulnerabilityInstanceRead(
                        id=synthetic_id,
                        project_id=d.project_id,
                        vulnerability_definition_id=d.id,
                        definition_title=d.title,
                        definition_severity=d.severity,
                        definition_cvss_score=d.cvss_score,
                        definition_description_md=d.description_md,
                        definition_evidence_md=d.evidence_md,
                        definition_cve_ids=d.cve_ids,
                        definition_discovered_by=d.discovered_by,
                        definition_created_at=d.created_at,
                        definition_updated_at=d.updated_at,
                        host_id=host_id,
                        port_id=None,
                        status="open",
                        notes_md=None,
                        created_at=d.created_at,
                        updated_at=d.updated_at,
                    )
                )
    return result
